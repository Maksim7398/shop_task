<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <changeSet author="Maksim7398" id="001-create-table-product">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="product"/>
            </not>
        </preConditions>
        <createTable tableName="product">
            <column name="id" remarks="its unique id" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="product_pkey"/>
            </column>
            <column name="title" type="VARCHAR(255)" remarks="name of products">
                <constraints nullable="false"/>
            </column>
            <column name="price" type="NUMERIC(7,2)" remarks="price of products">
                <constraints nullable="false"/>
            </column>
            <column name="article" type="VARCHAR(255)" remarks="article of products">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="quantity" type="INTEGER" remarks="count of products">
                <constraints nullable="false"/>
            </column>
            <column name="create_date" type="TIMESTAMP WITHOUT TIME ZONE" remarks="time of burn products">
                <constraints nullable="false"/>
            </column>
            <column name="last_quantity_change" type="TIMESTAMP WITHOUT TIME ZONE"
                    remarks="date change when product quantity changes">
                <constraints nullable="false"/>
            </column>
            <column name="category" type="VARCHAR(255)" remarks="types of products"/>
            <column name="description" type="VARCHAR(1000)" remarks="description and characteristics of products"/>
            <column name="is_available" type="BOOLEAN" remarks="is product isAvailable">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="002-init-records" author="Maksim7398">
        <sqlFile path="db/changelog/data.sql"/>
    </changeSet>
    <changeSet author="Maksim 7398" id="003-create-table-orders">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="orders"/>
            </not>
        </preConditions>
        <createTable tableName="orders">
            <column name="id" type="UUID" remarks="it`s order id">
                <constraints nullable="false" primaryKey="true" primaryKeyName="orders_pkey"/>
            </column>
            <column name="order_price" type="numeric(38, 2)" remarks="total price of order"/>
            <column name="status" type="VARCHAR(255)" remarks="status of order"/>
            <column name="create_date" type="TIMESTAMP WITHOUT TIME ZONE" remarks="create date of order"/>
            <column name="update_date" type="TIMESTAMP WITHOUT TIME ZONE" remarks="update date of order"/>
            <column name="user_id" type="UUID" remarks="user id when placed an order"/>
        </createTable>
    </changeSet>
    <changeSet author="Maksim 7398" id="004-create-table-ordered-product">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ordered_product"/>
            </not>
        </preConditions>
        <createTable tableName="ordered_product">
            <column name="price" type="numeric(38, 2)" remarks="price of one product in order"/>
            <column name="quantity" type="INTEGER" remarks="quantity of products in order"/>
            <column name="order_id" type="UUID" remarks="order id when was create order">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ordered_product_pkey"/>
            </column>
            <column name="product_id" type="UUID" remarks="product id was in create order">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ordered_product_pkey"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Maksim 7398" id="005-create-table-users">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        <createTable tableName="users">
            <column name="id" type="UUID" remarks="user id">
                <constraints nullable="false" primaryKey="true" primaryKeyName="users_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)" remarks="user name"/>
            <column name="email" type="VARCHAR(255)" remarks="user email"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="orders"
                                 constraintName="fk32ql8ubntj5uh44ph9659tiih"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION"
                                 referencedColumnNames="id"
                                 referencedTableName="users"
                                 validate="true"/>
    </changeSet>
    <changeSet id="006-ddForeignKeyForOrderedProduct" author="Maksim 7398">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk2nijit240cv1lx2ak4x5cakm8"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="order_id"
                                 baseTableName="ordered_product"
                                 constraintName="fk2nijit240cv1lx2ak4x5cakm8"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION"
                                 referencedColumnNames="id"
                                 referencedTableName="orders"
                                 validate="true"/>
    </changeSet>
</databaseChangeLog>
